
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>API Reference &#8212; ESA Geo Utils alpha documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Usage" href="usage.html" />

  <link rel="stylesheet" href="_static/custom.css" type="text/css" />


  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <section id="api-reference">
<h1>API Reference<a class="headerlink" href="#api-reference" title="Permalink to this headline">¶</a></h1>
<section id="module-cdap_geo_utils.io">
<span id="io"></span><h2>IO<a class="headerlink" href="#module-cdap_geo_utils.io" title="Permalink to this headline">¶</a></h2>
<p>Read various spatial vector formats into a Spark DataFrame.</p>
<section id="basic-usage">
<h3>Basic usage<a class="headerlink" href="#basic-usage" title="Permalink to this headline">¶</a></h3>
<p>Read the first layer from a file or files into a single Spark DataFrame:</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sdf</span> <span class="o">=</span> <span class="n">read_vector_files</span><span class="p">(</span>
<span class="go">    path=&quot;/path/to/files/&quot;,</span>
<span class="go">    suffix=&quot;.ext&quot;,</span>
<span class="go">)</span>
</pre></div>
</div>
</section>
<section id="reading-layers">
<h3>Reading layers<a class="headerlink" href="#reading-layers" title="Permalink to this headline">¶</a></h3>
<p>Read a specific layer for a file or files, using layer name:</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sdf</span> <span class="o">=</span> <span class="n">read_vector_files</span><span class="p">(</span>
<span class="go">    path=&quot;/path/to/files/&quot;,</span>
<span class="go">    suffix=&quot;.ext&quot;,</span>
<span class="go">    layer_identifier=&quot;layer_name&quot;</span>
<span class="go">)</span>
</pre></div>
</div>
<p>or layer index:</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sdf</span> <span class="o">=</span> <span class="n">read_vector_files</span><span class="p">(</span>
<span class="go">    path=&quot;/path/to/files/&quot;,</span>
<span class="go">    suffix=&quot;.ext&quot;,</span>
<span class="go">    layer_identifier=1</span>
<span class="go">)</span>
</pre></div>
</div>
</section>
<section id="gdal-virtual-file-systems">
<h3>GDAL Virtual File Systems<a class="headerlink" href="#gdal-virtual-file-systems" title="Permalink to this headline">¶</a></h3>
<p>Read compressed files using GDAL Virtual File Systems:</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sdf</span> <span class="o">=</span> <span class="n">read_vector_files</span><span class="p">(</span>
<span class="go">    path=&quot;/path/to/files/&quot;,</span>
<span class="go">    suffix=&quot;.gz&quot;,</span>
<span class="go">    layer_identifier=&quot;layer_name&quot;,</span>
<span class="go">    vsi_prefix=&quot;/vsigzip/&quot;,</span>
<span class="go">)</span>
</pre></div>
</div>
</section>
<section id="user-defined-schema">
<h3>User-defined Schema<a class="headerlink" href="#user-defined-schema" title="Permalink to this headline">¶</a></h3>
<p>By default, a schema will be generated from the first file in the folder. For a
single tabular dataset that has been partitioned across several files, this will
work fine.</p>
<p>However, it won’t work for a list format like GML, as not every file will contain
the same fields. In this case, you can define a schema yourself. You will also need
to set the coerce_to_schema flag to True.</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">(</span>
<span class="go">    [</span>
<span class="go">        StructField(&quot;id&quot;, LongType()),</span>
<span class="go">        StructField(&quot;category&quot;, StringType()),</span>
<span class="go">        StructField(&quot;geometry&quot;, BinaryType()),</span>
<span class="go">    ]</span>
<span class="go">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sdf</span> <span class="o">=</span> <span class="n">read_vector_files</span><span class="p">(</span>
<span class="go">    path=&quot;/path/to/files/&quot;,</span>
<span class="go">    suffix=&quot;.ext&quot;,</span>
<span class="go">    layer_identifier=&quot;layer_name&quot;,</span>
<span class="go">    schema=schema,</span>
<span class="go">    coerce_to_schema=True,</span>
<span class="go">)</span>
</pre></div>
</div>
</section>
<section id="concurrency-strategy">
<h3>Concurrency Strategy<a class="headerlink" href="#concurrency-strategy" title="Permalink to this headline">¶</a></h3>
<p>By default, the function will parallelise across files.</p>
<p>This should work well for single dataset that has been partitioned across several
files. Especially if it has been partition so that those individual files can be
comfortably read into memory on a single machine.</p>
<p>However, the function also provides a way of parallelising across chunks of rows
within a file or files.</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sdf</span> <span class="o">=</span> <span class="n">read_vector_files</span><span class="p">(</span>
<span class="go">    path=&quot;/path/to/files/&quot;,</span>
<span class="go">    suffix=&quot;.ext&quot;,</span>
<span class="go">    concurrency_strategy=&quot;rows&quot;,</span>
<span class="go">)</span>
</pre></div>
</div>
<p>By default, a chunk will consist of 3 million rows but you cab change this using the
ideal_chunk_size parameter.</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sdf</span> <span class="o">=</span> <span class="n">read_vector_files</span><span class="p">(</span>
<span class="go">    path=&quot;/path/to/files/&quot;,</span>
<span class="go">    suffix=&quot;.ext&quot;,</span>
<span class="go">    concurrency_strategy=&quot;rows&quot;,</span>
<span class="go">    ideal_chunk_size=5_000_000,</span>
<span class="go">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Reading chunks adds a substantial overhead as files have to be opened to get a row
count. The “rows” strategy should only be used for a single large file or a small
number of large files.</p>
</div>
<dl class="py function">
<dt class="sig sig-object py" id="cdap_geo_utils.io.read_vector_files">
<span class="sig-prename descclassname"><span class="pre">cdap_geo_utils.io.</span></span><span class="sig-name descname"><span class="pre">read_vector_files</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path:</span> <span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ogr_to_spark_type_map:</span> <span class="pre">mappingproxy</span> <span class="pre">=</span> <span class="pre">mappingproxy({'Binary':</span> <span class="pre">BinaryType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'Date':</span> <span class="pre">StringType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'DateTime':</span> <span class="pre">StringType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'Integer':</span> <span class="pre">IntegerType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'IntegerList':</span> <span class="pre">ArrayType(IntegerType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">true)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'Integer64':</span> <span class="pre">LongType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'Integer64List':</span> <span class="pre">ArrayType(LongType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">true)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'Real':</span> <span class="pre">FloatType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'RealList':</span> <span class="pre">ArrayType(FloatType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">true)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'String':</span> <span class="pre">StringType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'StringList':</span> <span class="pre">ArrayType(StringType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">true)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'Time':</span> <span class="pre">StringType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'WideString':</span> <span class="pre">StringType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'WideStringList':</span> <span class="pre">ArrayType(StringType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">true)})</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">suffix:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'*'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ideal_chunk_size:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">3000000</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">geom_field_name:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'geometry'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">geom_field_type:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'Binary'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">coerce_to_schema:</span> <span class="pre">bool</span> <span class="pre">=</span> <span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spark_to_pandas_type_map:</span> <span class="pre">mappingproxy</span> <span class="pre">=</span> <span class="pre">mappingproxy({ArrayType(FloatType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">true):</span> <span class="pre">&lt;class</span> <span class="pre">'numpy.object_'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ArrayType(IntegerType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">true):</span> <span class="pre">&lt;class</span> <span class="pre">'numpy.object_'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ArrayType(LongType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">true):</span> <span class="pre">&lt;class</span> <span class="pre">'numpy.object_'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ArrayType(StringType</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">true):</span> <span class="pre">&lt;class</span> <span class="pre">'numpy.object_'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">BinaryType:</span> <span class="pre">&lt;class</span> <span class="pre">'numpy.object_'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">FloatType:</span> <span class="pre">&lt;class</span> <span class="pre">'numpy.float32'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">IntegerType:</span> <span class="pre">&lt;class</span> <span class="pre">'numpy.int32'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">LongType:</span> <span class="pre">&lt;class</span> <span class="pre">'numpy.int64'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">StringType:</span> <span class="pre">&lt;class</span> <span class="pre">'numpy.object_'&gt;})</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">vsi_prefix:</span> <span class="pre">Optional[str]</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">schema:</span> <span class="pre">Optional[pyspark.sql.types.StructType]</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">layer_identifier:</span> <span class="pre">Optional[Union[str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">int]]</span> <span class="pre">=</span> <span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">concurrency_strategy:</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">'files'</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">pyspark.sql.dataframe.DataFrame</span></span></span><a class="headerlink" href="#cdap_geo_utils.io.read_vector_files" title="Permalink to this definition">¶</a></dt>
<dd><p>Read vector file(s) into a Spark DataFrame.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>path</strong> (<em>str</em>) – [description]</p></li>
<li><p><strong>ogr_to_spark_type_map</strong> (<em>MappingProxyType</em>) – [description]. Defaults
to OGR_TO_SPARK.</p></li>
<li><p><strong>suffix</strong> (<em>str</em>) – [description]. Defaults to “*”.</p></li>
<li><p><strong>ideal_chunk_size</strong> (<em>int</em>) – [description]. Defaults to 3_000_000.</p></li>
<li><p><strong>geom_field_name</strong> (<em>str</em>) – [description]. Defaults to “geometry”.</p></li>
<li><p><strong>geom_field_type</strong> (<em>str</em>) – [description]. Defaults to “Binary”.</p></li>
<li><p><strong>coerce_to_schema</strong> (<em>bool</em>) – [description]. Defaults to False.</p></li>
<li><p><strong>spark_to_pandas_type_map</strong> (<em>MappingProxyType</em>) – [description]. Defaults
to SPARK_TO_PANDAS.</p></li>
<li><p><strong>vsi_prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – [description]. Defaults to None.</p></li>
<li><p><strong>schema</strong> (<em>StructType</em>) – [description]. Defaults to None.</p></li>
<li><p><strong>layer_identifier</strong> (<em>str</em><em>, </em><em>optional</em>) – [description]. Defaults to None.</p></li>
<li><p><strong>concurrency_strategy</strong> (<em>str</em>) – [description]. Defaults to “files”.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>[description]</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>SparkDataFrame</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="cdap_geo_utils.io.temporary_spark_context">
<span class="sig-prename descclassname"><span class="pre">cdap_geo_utils.io.</span></span><span class="sig-name descname"><span class="pre">temporary_spark_context</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">configuration_key</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">new_configuration_value</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">spark</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">pyspark.sql.session.SparkSession</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Iterator</span><span class="p"><span class="pre">[</span></span><span class="pre">pyspark.sql.session.SparkSession</span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#cdap_geo_utils.io.temporary_spark_context" title="Permalink to this definition">¶</a></dt>
<dd><p>Changes then resets spark configuration.</p>
</dd></dl>

</section>
</section>
<section id="module-cdap_geo_utils.indexing">
<span id="indexing"></span><h2>Indexing<a class="headerlink" href="#module-cdap_geo_utils.indexing" title="Permalink to this headline">¶</a></h2>
<p>Create grid-based spatial indexes.</p>
<section id="id1">
<h3>Basic Usage<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Calculate the grid index or indices for a geometry provided in
well-known binary format at a given resolution:</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pnt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">555000</span><span class="p">,</span> <span class="mi">185000</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bng_pnt</span> <span class="o">=</span> <span class="n">calculate_bng_index</span><span class="p">(</span>
<span class="go">    wkb = pnt.wkb,</span>
<span class="go">    resolution = 100,</span>
<span class="go">)</span>
</pre></div>
</div>
</section>
<section id="changing-resolution">
<h3>Changing Resolution<a class="headerlink" href="#changing-resolution" title="Permalink to this headline">¶</a></h3>
<p>Indices can be calculated for cell sizes of 1m, 10m, 100m, 1000m, 10000m and 100000m:</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">LineString</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">line</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">([(</span><span class="mi">450750</span><span class="p">,</span> <span class="mi">175000</span><span class="p">),</span> <span class="p">(</span><span class="mi">535000</span><span class="p">,</span> <span class="mi">195250</span><span class="p">)])</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bng_line</span> <span class="o">=</span> <span class="n">calculate_bng_index</span><span class="p">(</span>
<span class="go">    wkb = line.wkb,</span>
<span class="go">    resolution = 1000,</span>
<span class="go">)</span>
</pre></div>
</div>
</section>
<section id="index-creation-options">
<h3>Index Creation Options<a class="headerlink" href="#index-creation-options" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">how</span></code> argument can be used to change the kind of indices created.</p>
<section id="points-and-multi-points">
<h4>Points and Multi-Points<a class="headerlink" href="#points-and-multi-points" title="Permalink to this headline">¶</a></h4>
<p>The default and only option for <code class="docutils literal notranslate"><span class="pre">how</span></code> is ‘intersects’. This returns the
British National Grid index that the point falls within. If the point lies
on an edge or corner of the grid cell then 2 or 4 grid cells indices are
returned as appropriate.</p>
</section>
<section id="linestrings-and-multilinestrings">
<h4>LineStrings and MultiLineStrings<a class="headerlink" href="#linestrings-and-multilinestrings" title="Permalink to this headline">¶</a></h4>
<p>The default options for <code class="docutils literal notranslate"><span class="pre">how</span></code> is ‘intersects’. This returns all indices for
the British National Grid cells that the line geometry intersects. An alternative
option is ‘bounding box’, which returns all indices that intersect with the
bounding box of the line geometry:</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bng_line</span> <span class="o">=</span> <span class="n">calculate_bng_index</span><span class="p">(</span>
<span class="go">    wkb = line.wkb,</span>
<span class="go">    resolution = 100,</span>
<span class="go">    how = &#39;bounding box&#39;</span>
<span class="go">)</span>
</pre></div>
</div>
<p>Although bounding boxes are fast to compute, in most cases ‘intersects’ will be
preferable as bounding box indexing, particularly at higher resolutions, will lead
to considerable redundancy.</p>
</section>
<section id="polygons-and-multipolygons">
<h4>Polygons and MultiPolygons<a class="headerlink" href="#polygons-and-multipolygons" title="Permalink to this headline">¶</a></h4>
<p>The default option for <code class="docutils literal notranslate"><span class="pre">how</span></code> is ‘intersects’, but alternative options of
‘bounding box’ and ‘contains’ are also available. The ‘bounding box’ returns
the British National Grid indices which intersect the Polygon bounding box.
The ‘contains’ option returns one or more tuples containing the indices that
intersect the Polygon and a boolean, where <code class="docutils literal notranslate"><span class="pre">true</span></code> indicates that the grid
cell is contained within the Polygon and <code class="docutils literal notranslate"><span class="pre">false</span></code> that the grid cell intersects
the Polygon, but doesn’t lie within it (e.g. the cell crosses the Polygon boundary).</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([(</span><span class="mi">535000</span><span class="p">,</span> <span class="mi">175000</span><span class="p">),</span>
<span class="go">                    (555250, 185000),</span>
<span class="go">                    (556000, 162500),</span>
<span class="go">                    (527500, 160333),</span>
<span class="go">                    (535000, 175000)])</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bng_poly</span> <span class="o">=</span> <span class="n">calculate_bng_index</span><span class="p">(</span>
<span class="go">    wkb = poly.wkb,</span>
<span class="go">    resolution = 100,</span>
<span class="go">    how = &#39;contains&#39;</span>
<span class="go">)</span>
</pre></div>
</div>
</section>
</section>
<section id="intended-usage">
<h3>Intended Usage<a class="headerlink" href="#intended-usage" title="Permalink to this headline">¶</a></h3>
<p>The top-level <code class="docutils literal notranslate"><span class="pre">calculate_bng_index()</span></code> function is intended to be applied
over a column of geometries. The approach will support mixes of geometry types
in a single column. Although it is primarily intended for use in Spark, we
first present an example using <code class="docutils literal notranslate"><span class="pre">geopandas</span></code> which may be more familiar:</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">geopandas</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gdf</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;some file of interest&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bng</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">calculate_bng_index</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">wkb</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
<span class="go">                    index = 1)</span>
</pre></div>
</div>
<p>When using the function in spark, the same approach applies, however you first
need to create a user-defined function (udf).</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">ArrayType</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@udf</span><span class="p">(</span><span class="n">returnType</span><span class="o">=</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">StringType</span><span class="p">()))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">apply_index</span><span class="p">(</span><span class="n">wkb</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="go">        return calculate_bng_index(wkb, resolution=100, how=&#39;intersects&#39;)</span>
</pre></div>
</div>
<p>This user defined function can then be applied to a spark dataframe, assuming it stores
the geometry in well-known binary format:</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sdf</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="s1">&#39;some parquet file of interest&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sdf</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;bng&#39;</span><span class="p">,</span> <span class="n">apply_index</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>The intent of the indexing is that it can then be used to benefit geospatial
filtering and joining operations.</p>
</section>
<section id="get-british-national-grid-cell-geometries">
<h3>Get British National Grid Cell Geometries<a class="headerlink" href="#get-british-national-grid-cell-geometries" title="Permalink to this headline">¶</a></h3>
<p>A top-level helper function is provided for simple translation of British National
Grid references into well-known text that can be plotted. The resolution is inferred
from each reference:</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">geopandas</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">shapely.wkt</span> <span class="kn">import</span> <span class="n">loads</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">box</span> <span class="o">=</span> <span class="n">wkt_from_bng</span><span class="p">(</span><span class="s2">&quot;TQ3415&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gdf</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span> <span class="o">=</span> <span class="p">[</span><span class="n">box</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">wkt_from_bng()</span></code> function is also designed to be applied to collections of
references:</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">geopandas</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">shapely.wkt</span> <span class="kn">import</span> <span class="n">loads</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">boxes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">wkt_from_bng</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;TQ3415&quot;</span><span class="p">,</span> <span class="s2">&quot;SP4087&quot;</span><span class="p">,</span> <span class="s2">&quot;SS9015&quot;</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gdf</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
</section>


          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">ESA Geo Utils</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#module-cdap_geo_utils.io">IO</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#basic-usage">Basic usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reading-layers">Reading layers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gdal-virtual-file-systems">GDAL Virtual File Systems</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-defined-schema">User-defined Schema</a></li>
<li class="toctree-l3"><a class="reference internal" href="#concurrency-strategy">Concurrency Strategy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-cdap_geo_utils.indexing">Indexing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Basic Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#changing-resolution">Changing Resolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#index-creation-options">Index Creation Options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#points-and-multi-points">Points and Multi-Points</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linestrings-and-multilinestrings">LineStrings and MultiLineStrings</a></li>
<li class="toctree-l4"><a class="reference internal" href="#polygons-and-multipolygons">Polygons and MultiPolygons</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#intended-usage">Intended Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-british-national-grid-cell-geometries">Get British National Grid Cell Geometries</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="usage.html" title="previous chapter">Usage</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Ed Fawcett-Taylor, Dan Lewis.

      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>

      |
      <a href="_sources/api.rst.txt"
          rel="nofollow">Page source</a>
    </div>




  </body>
</html>
